from telegram import Update
from telegram.ext import ContextTypes
from keyboards.main_menu import get_main_keyboard
from services.auth_manager import auth_manager
from services.user_manager import user_manager


async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user = update.effective_user

    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∏–º–µ–Ω–µ–º –∏ —Ñ–∞–º–∏–ª–∏–µ–π
    auth_manager.register_user(
        user.id,
        user.username,
        user.first_name,
        user.last_name
    )

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, approved –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    if auth_manager.is_user_approved(user.id):
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ user_manager
        user_manager.initialize_user(user.id, user.username)

        welcome_text = (
            "üëã <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Shift Tracker Bot!</b>\n\n"
            "üìÖ –Ø –ø–æ–º–æ–≥—É –≤–∞–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤–∞—à —Å–º–µ–Ω–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã.\n\n"
            "‚ö° <b>–ß—Ç–æ —è —É–º–µ—é:</b>\n"
            "‚Ä¢ –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤–∞—à–∏ —Å–º–µ–Ω—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∏ –∑–∞–≤—Ç—Ä–∞\n"
            "‚Ä¢ –†–∞–±–æ—Ç–∞—Ç—å —Å —Ä–∞–∑–Ω—ã–º–∏ –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ —Ä–∞–±–æ—Ç—ã\n"
            "‚Ä¢ –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–º–µ–Ω—ã –Ω–∞ –ª—é–±—É—é –¥–∞—Ç—É\n"
            "‚Ä¢ –£–ø—Ä–∞–≤–ª—è—Ç—å –≤–∞—à–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏\n\n"
        )

        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∞–≤–∞—Ö –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
        if auth_manager.is_admin(user.id):
            welcome_text += "‚ö° <b>–í—ã —è–≤–ª—è–µ—Ç–µ—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —Å–∏—Å—Ç–µ–º—ã!</b>\n"
            welcome_text += "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /admin_help –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–¥–º–∏–Ω. –∫–æ–º–∞–Ω–¥\n\n"

        welcome_text += (
            "üìã <b>–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:</b>\n"
            "‚Ä¢ –ù–∞–∂–º–∏—Ç–µ 'üìÖ –°–µ–≥–æ–¥–Ω—è' –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π —Å–º–µ–Ω—ã\n"
            "‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è –ø–æ–ª–Ω–æ–π —Å–ø—Ä–∞–≤–∫–∏\n"
            "‚Ä¢ –ü–∏—à–∏—Ç–µ –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–º–µ–Ω\n\n"
            "üöÄ <b>–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è!</b>"
        )

        await update.message.reply_text(welcome_text, parse_mode='HTML', reply_markup=get_main_keyboard())
    else:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ approved
        await update.message.reply_text(
            f"‚ùå <b>–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –æ–∂–∏–¥–∞–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è</b>\n\n"
            f"üÜî <b>–í–∞—à ID:</b> <code>{user.id}</code>\n"
            f"üìã –ü–µ—Ä–µ–¥–∞–π—Ç–µ —ç—Ç–æ—Ç ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.\n\n"
            f"–ü–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –≤—ã —Å–º–æ–∂–µ—Ç–µ:\n"
            f"‚Ä¢ –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Å–≤–æ–∏ —Å–º–µ–Ω—ã\n"
            f"‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–æ—Ç–∞\n"
            f"‚Ä¢ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏ —Ä–∞–±–æ—Ç—ã\n\n"
            f"‚è≥ –û–±—ã—á–Ω–æ –æ–¥–æ–±—Ä–µ–Ω–∏–µ –∑–∞–Ω–∏–º–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.",
            parse_mode='HTML'
        )